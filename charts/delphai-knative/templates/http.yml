{{ if  .Values.http.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    matchLabels:
      app: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}
    spec:
      imagePullSecrets:
        - name: acr-credentials
      automountServiceAccountToken: true
      containers:
        - name: {{ .Release.Name }}
          image: {{ .Values.image }}
          imagePullPolicy: Always
          {{ if gt (len .Values.command) 0 }}
          command: {{ .Values.command }}
          {{ end }}
          args: {{ .Values.args }}
          env:
            - name: DELPHAI_ENVIRONMENT
              value: {{ .Values.delphaiEnvironment }}
            {{- range .Values.env }}
            - name: {{ .name }}
              value: {{ .value }}
            {{- end }}
          ports:
            - containerPort: {{ .Values.http.port }}
---
apiVersion: v1
kind: Service
metadata:
  name: '{{ .Release.Name }}-http-public'
  namespace: {{ .Release.Namespace }}
spec:
  selector:
    app: {{ .Release.Name }}
  ports:
    - name: http
      port: {{ .Values.http.port }}
      targetPort: {{ .Values.http.port }}
---
apiVersion: projectcontour.io/v1
kind: HTTPProxy
metadata:
  name: '{{ .Release.Name }}-http-public'
  namespace: {{ .Release.Namespace }}
  annotations:
    projectcontour.io/ingress.class: contour-external
spec:
  virtualhost:
    fqdn: 'api.{{ .Values.domain }}'
  routes:
    - conditions:
        - prefix: '/{{ .Release.Name }}'
      services:
        - name: '{{ .Release.Name }}-http-public'
          port: {{ .Values.http.port }}
      pathRewritePolicy:
        replacePrefix:
          - replacement: /
{{ end }}
